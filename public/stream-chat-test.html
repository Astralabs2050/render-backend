<!DOCTYPE html>
<html>
<head>
    <title>Chat AI Test</title>
    <script src="https://cdn.jsdelivr.net/npm/stream-chat@1.2.2/dist/browser.full-bundle.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .setup { background: #f5f5f5; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .chat-container { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 15px; margin: 10px 0; background: #fafafa; }
        .message { margin: 10px 0; padding: 10px; border-radius: 8px; max-width: 80%; }
        .user { background: #007bff; color: white; margin-left: auto; text-align: right; }
        .ai { background: #e9ecef; color: #333; }
        .system { background: #fff3cd; color: #856404; margin: 0 auto; text-align: center; font-style: italic; }
        input, button { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        #messageInput { width: 70%; }
        .typing { color: #666; font-style: italic; }
        .dots { animation: blink 1.5s infinite; }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <h1>Astra AI Test</h1>
    
    <div class="setup">
        <h3>Setup</h3>
        <input type="text" id="tokenInput" placeholder="JWT Token" style="width: 45%;">
        <input type="text" id="userIdInput" placeholder="User ID" style="width: 30%;">
        <button onclick="initializeChat()">Initialize</button>
        <br><br>
        <input type="text" id="chatIdInput" placeholder="Chat ID" style="width: 60%;">
        <button onclick="startChat()">Start Chat</button>
        <br><br>
        <button onclick="autoLogin()" style="background: #28a745;">Auto Login (Test User)</button>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="system">Initialize and start chat to begin</div>
    </div>
    
    <div>
        <input type="text" id="messageInput" placeholder="Type your message..." disabled>
        <button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
    </div>
    
    <script>
        let chatClient;
        let channel;
        let currentUserId;
        let currentChatId;
        let isAITyping = false;
        let activeRequests = new Set();
        
        async function initializeChat() {
            const token = document.getElementById('tokenInput').value.trim();
            const userId = document.getElementById('userIdInput').value.trim();
            
            if (!token || !userId) {
                alert('Please enter both JWT token and User ID');
                return;
            }
            
            try {

                let attempts = 0;
                while (typeof StreamChat === 'undefined' && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }
                
                if (typeof StreamChat === 'undefined') {
                    addMessage('system', 'StreamChat library failed to load. Please refresh the page.');
                    return;
                }
                
                // Get Stream Chat token from backend
                const response = await fetch('/ai-chat/token', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (!data.status) {
                    throw new Error(data.message);
                }
                
                // Initialize Stream Chat client
                chatClient = new StreamChat(data.data.apiKey);
                chatClient.setUser({ id: userId }, data.data.token);
                
                currentUserId = userId;
                addMessage('system', 'Connected to Stream Chat!');
                
                // Auto start chat
                setTimeout(() => {
                    startChat();
                }, 500);
                
            } catch (error) {
                addMessage('system', `Error: ${error.message}`);
            }
        }
        
        async function startChat() {
            if (!chatClient) {
                addMessage('system', 'Chat client not initialized');
                return;
            }
            
            // Cancel any active requests
            activeRequests.forEach(controller => controller.abort());
            activeRequests.clear();
            
            addMessage('system', 'Starting chat...');
            const chatId = document.getElementById('chatIdInput').value.trim();
            
            try {
                if (chatId) {
                    // Use existing chat
                    currentChatId = chatId;
                    addMessage('system', `Using existing chat: ${chatId}`);
                } else {
                    // Start new chat via API
                    addMessage('system', 'Creating new chat...');
                    const token = document.getElementById('tokenInput').value.trim();
                    const response = await fetch('/ai-chat/start', {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    
                    if (!data.status) {
                        throw new Error(data.message);
                    }
                    
                    currentChatId = data.data.id;
                    addMessage('system', `New chat created: ${currentChatId}`);
                }
                
                // Create channel
                addMessage('system', 'Creating Stream Chat channel...');
                channel = chatClient.channel('messaging', currentChatId);
                
                // Watch channel
                addMessage('system', 'Watching channel...');
                await channel.watch();
                
                // Listen for new messages
                channel.on('message.new', (event) => {
                    const role = event.user.id === currentUserId ? 'user' : 'ai';
                    
                    // Hide typing indicator and re-enable input when AI responds
                    if (role === 'ai') {
                        hideTypingIndicator();
                        enableInput();
                    }
                    
                    addMessage(role, event.message.text);
                });
                
                // Load existing messages
                addMessage('system', 'Loading messages...');
                const messages = await channel.query({ messages: { limit: 50 } });
                
                // Clear container and show messages
                document.getElementById('chatContainer').innerHTML = '';
                messages.messages.forEach(msg => {
                    const role = msg.user.id === currentUserId ? 'user' : 'ai';
                    addMessage(role, msg.text);
                });
                
                // Enable input
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                
                addMessage('system', `Chat ready! ID: ${currentChatId}`);
                
            } catch (error) {
                addMessage('system', `Start chat error: ${error.message}`);
                console.error('Start chat error:', error);
            }
        }
        
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !channel || isAITyping) return;
            
            try {
                // Disable input while processing
                messageInput.disabled = true;
                document.getElementById('sendBtn').disabled = true;
                isAITyping = true;
                
                // Send message to Stream Chat (this will trigger the listener automatically)
                await channel.sendMessage({ text: content });
                messageInput.value = '';
                
                // Show typing indicator
                showTypingIndicator();
                
                // Also send to AI backend for processing
                const token = document.getElementById('tokenInput').value.trim();
                
                // No timeout - let request complete naturally
                
                const controller = new AbortController();
                activeRequests.add(controller);
                
                const response = await fetch('/ai-chat/message', {
                    method: 'POST',
                    signal: controller.signal,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatId: currentChatId,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Request completed successfully
                activeRequests.delete(controller);
                
                // Re-enable input after successful request
                enableInput();
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    addMessage('system', 'Request cancelled');
                } else if (error.message === 'Failed to fetch') {
                    addMessage('system', 'Backend server is not responding. Please check if the server is running on the correct port.');
                } else {
                    addMessage('system', `Error: ${error.message}`);
                }
                hideTypingIndicator();
                enableInput();
            }
        }
        
        function enableInput() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            isAITyping = false;
        }
        
        function showTypingIndicator() {
            hideTypingIndicator(); // Remove any existing
            const container = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'message ai typing';
            typingDiv.innerHTML = 'Astra AI is typing<span class="dots">...</span>';
            container.appendChild(typingDiv);
            setTimeout(() => container.scrollTop = container.scrollHeight, 10);
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        async function loadMessages() {
            if (!currentChatId) return;
            
            try {
                const token = document.getElementById('tokenInput').value.trim();
                const response = await fetch(`/ai-chat/${currentChatId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.status && data.data.messages) {
                    document.getElementById('chatContainer').innerHTML = '';
                    data.data.messages.forEach(msg => {
                        const role = msg.role === 'user' ? 'user' : 'ai';
                        addMessage(role, msg.content);
                    });
                }
            } catch (error) {
                addMessage('system', `Error loading messages: ${error.message}`);
            }
        }
        
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            // Check if content contains image URLs and render them
            if (content.includes('http') && (content.includes('.jpg') || content.includes('.png') || content.includes('cloudinary'))) {
                const lines = content.split('\n');
                lines.forEach(line => {
                    if (line.includes('http') && (line.includes('.jpg') || line.includes('.png') || line.includes('cloudinary'))) {
                        const urlMatch = line.match(/(https?:\/\/[^\s]+)/g);
                        if (urlMatch) {
                            const img = document.createElement('img');
                            img.src = urlMatch[0];
                            img.style.maxWidth = '300px';
                            img.style.borderRadius = '8px';
                            img.style.margin = '10px 0';
                            messageDiv.appendChild(img);
                        }
                    } else {
                        const textNode = document.createElement('div');
                        textNode.textContent = line;
                        messageDiv.appendChild(textNode);
                    }
                });
            } else {
                messageDiv.textContent = content;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Auto login function
        async function autoLogin() {
            try {
                // Use test-auth endpoint to create verified user
                const response = await fetch('/test-auth/create-verified-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'Test123!@#',
                        fullName: 'Test User',
                        userType: 'creator'
                    })
                });
                
                const data = await response.json();
                
                if (data.status && data.data.accessToken) {
                    document.getElementById('tokenInput').value = data.data.accessToken;
                    document.getElementById('userIdInput').value = data.data.user.id;
                    addMessage('system', 'Auto login successful!');
                    
                    // Auto initialize chat
                    setTimeout(() => {
                        initializeChat();
                    }, 500);
                } else {
                    addMessage('system', 'Auto login failed: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                addMessage('system', 'Auto login error: ' + error.message);
            }
        }
        
        // Auto-fill from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const tokenParam = urlParams.get('token');
        const userIdParam = urlParams.get('userId');
        
        if (tokenParam) {
            document.getElementById('tokenInput').value = tokenParam;
        }
        if (userIdParam) {
            document.getElementById('userIdInput').value = userIdParam;
        }
        

        
        // Enter key to send
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>